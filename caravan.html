<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Caravan — Caravans Tasmania</title>
  <meta name="description" content="View caravan details, photos and specifications."/>
  <link rel="icon" href="assets/ct_logo_email_600_white.png"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .nav-backdrop{backdrop-filter:saturate(180%) blur(8px);-webkit-backdrop-filter:saturate(180%) blur(8px)}
    .thumb.active { outline: 2px solid #0ea5e9; }
  </style>
</head>
<body class="bg-white text-slate-800">
  <!-- top bar -->
  <div class="w-full bg-slate-900 text-white text-sm">
    <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between">
      <a href="tel:+61363437287" class="hover:underline">Call (03) 6343 7287</a>
      <div class="space-x-4 hidden sm:block">
        <a href="https://www.facebook.com/caravanstasmania/" target="_blank" rel="noopener" class="hover:underline">Facebook</a>
      </div>
    </div>
  </div>

  <!-- header -->
  <header class="sticky top-0 z-40 bg-white/80 nav-backdrop border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <a href="index.html#home" class="flex items-center space-x-3">
          <img src="assets/ct_logo_email_600_white.png" alt="Caravans Tasmania" class="h-10 w-auto object-contain"/>
          <span class="sr-only">Caravans Tasmania</span>
        </a>
        <nav class="hidden md:flex items-center space-x-6">
          <a href="index.html#home">Home</a>
          <a href="stock.html" class="font-semibold text-slate-900">Stock</a>
          <a href="index.html#services">Services</a>
          <a href="index.html#about">About</a>
          <a href="index.html#contact">Contact</a>
        </nav>
        <button id="menuBtn" class="md:hidden p-2 rounded hover:bg-slate-100" aria-label="Open Menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
      </div>
    </div>
    <div id="mobileNav" class="md:hidden hidden border-t border-slate-200 bg-white">
      <nav class="max-w-7xl mx-auto px-4 py-4 grid gap-3">
        <a href="index.html#home" class="py-2">Home</a>
        <a href="stock.html" class="py-2">Stock</a>
        <a href="index.html#services" class="py-2">Services</a>
        <a href="index.html#about" class="py-2">About</a>
        <a href="index.html#contact" class="py-2">Contact</a>
      </nav>
    </div>
  </header>

  <main class="py-10">
    <div class="max-w-7xl mx-auto px-4">
      <a href="stock.html" class="text-sm underline">← Back to stock</a>

      <div id="van" class="mt-4 grid lg:grid-cols-2 gap-8">
        <!-- Gallery -->
        <section>
          <div class="relative rounded-xl overflow-hidden border border-slate-200">
            <img id="mainImg" src="assets/placeholder.jpg" alt="" class="w-full h-80 object-cover">
          </div>
          <div id="thumbs" class="mt-3 grid grid-cols-5 sm:grid-cols-6 gap-2"></div>
        </section>

        <section>
          <div class="flex items-start gap-3">
            <h1 id="title" class="text-2xl font-semibold">Loading…</h1>
            <span id="soldTag" class="hidden text-xs px-2 py-1 rounded bg-red-600 text-white mt-1">Sold</span>
          </div>
          <p id="meta" class="mt-1 text-slate-600"></p>
          <p id="price" class="mt-2 text-xl font-semibold"></p>

          <div class="mt-4 flex gap-3">
            <a id="enquire" href="#" class="px-4 py-2 rounded-lg bg-slate-900 text-white">Enquire</a>
            <a href="index.html#contact" class="px-4 py-2 rounded-lg border">Visit showroom</a>
          </div>

          <div id="desc" class="prose prose-slate max-w-none mt-6"></div>

          <div class="mt-8 grid md:grid-cols-2 gap-6">
            <div>
              <h2 class="font-semibold">Specifications</h2>
              <dl id="specs" class="mt-2 text-sm grid grid-cols-2 gap-y-1"></dl>
            </div>
            <div>
              <h2 class="font-semibold">Added Features</h2>
              <ul id="features" class="mt-2 text-sm list-disc list-inside space-y-1"></ul>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- footer -->
  <footer class="bg-slate-900 text-slate-200 mt-10">
    <div class="max-w-7xl mx-auto px-4 py-12 grid md:grid-cols-4 gap-8">
      <div>
        <h4 class="font-semibold">Caravans Tasmania</h4>
        <p class="text-sm text-slate-400 mt-2">Sales & Service: 389 Hobart Road, Youngtown TAS 7249</p>
        <p class="mt-2 text-sm">Phone: <a class="underline" href="tel:+61363437287">(03) 6343 7287</a><br/>Email: <a class="underline" href="mailto:reception@caravanstas.com.au">reception@caravanstas.com.au</a></p>
      </div>
      <div>
        <h5 class="font-semibold">Hours</h5>
        <p class="text-sm text-slate-400 mt-2">Mon–Fri 8:30–5:00<br/>Sat 8:00–12:00</p>
      </div>
      <div class="md:col-span-2">
        <h5 class="font-semibold">Ready to view?</h5>
        <p class="text-sm text-slate-300 mt-2">Drop in or contact us to organise a time.</p>
      </div>
    </div>
    <div class="border-t border-slate-700">
      <div class="max-w-7xl mx-auto px-4 py-6 text-sm flex items-center justify-between">
        <p>© <span id="year"></span> Caravans Tasmania. All rights reserved.</p>
        <div class="space-x-4">
          <a href="stock.html" class="hover:underline">Stock</a>
          <a href="index.html#contact" class="hover:underline">Contact</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const menuBtn=document.getElementById('menuBtn'), mobileNav=document.getElementById('mobileNav');
    function toggleNav(open){const isOpen=open??mobileNav.classList.contains('hidden');mobileNav.classList.toggle('hidden',!isOpen);menuBtn?.setAttribute('aria-expanded',String(isOpen));}
    menuBtn?.addEventListener('click',()=>toggleNav());
    mobileNav?.querySelectorAll('a').forEach(a=>a.addEventListener('click',()=>toggleNav(false)));
    document.addEventListener('keydown',e=>{if(e.key==='Escape')toggleNav(false);});

    // ===== PocketBase setup =====
    const PB_BASE = "https://compilation-race-conduct-mud.trycloudflare.com"; // change if tunnel changes
    const PB_COLLECTION = "caravans";
    const id = new URLSearchParams(location.search).get('id');

    const mainImg = document.getElementById('mainImg');
    const thumbs = document.getElementById('thumbs');
    const titleEl = document.getElementById('title');
    const metaEl = document.getElementById('meta');
    const priceEl = document.getElementById('price');
    const descEl = document.getElementById('desc');
    const specsEl = document.getElementById('specs');
    const featuresEl = document.getElementById('features');
    const enquireEl = document.getElementById('enquire');
    const soldTag = document.getElementById('soldTag');

    const currency = n=>{
      if(n===null||n===undefined||n==='')return'POA';
      const num=typeof n==='number'?n:parseFloat(n);
      if(isNaN(num))return'POA';
      return num.toLocaleString('en-AU',{style:'currency',currency:'AUD',maximumFractionDigits:0});
    };

    function fileUrl(rec,file,size="1600x1000"){
      if(!file)return"assets/placeholder.jpg";
      const col=rec.collectionId||rec.collectionName||PB_COLLECTION;
      return `${PB_BASE}/api/files/${encodeURIComponent(col)}/${encodeURIComponent(rec.id)}/${encodeURIComponent(file)}?thumb=${size}`;
    }

    async function loadCaravan(){
      if(!id){titleEl.textContent="Missing ID";return;}
      try{
        const res=await fetch(`${PB_BASE}/api/collections/${PB_COLLECTION}/records/${id}`,{cache:'no-store'});
        if(!res.ok)throw new Error(res.status);
        const rec=await res.json();
        render(rec);
      }catch(err){
        console.error('PB error',err);
        titleEl.textContent="Not found";
      }
    }

    function render(rec){
      const title=rec.Title||[rec.Brand,rec.Model].filter(Boolean).join(" ")||"(Untitled)";
      const price=typeof rec.Price==="number"?rec.Price:parseFloat((rec.Price||"").toString().replace(/[^\d.]/g,""))||null;
      const cond=(rec.Condition||"").toLowerCase();
      const stat=(rec.Status||"").toLowerCase();
      const sold=stat==="sold";

      document.title=`${title} — Caravans Tasmania`;
      titleEl.textContent=title;
      metaEl.textContent=[rec.Size?`${rec.Size} ft`:"",rec.berths?`${rec.berths} berth`:"",rec.suspension].filter(Boolean).join(" • ");
      priceEl.textContent=currency(price);
      if(sold)soldTag.classList.remove("hidden");

      descEl.innerHTML=rec.description||"";

      // images
      const imgs=[];
      if(rec.Main_image)imgs.push(rec.Main_image);
      if(Array.isArray(rec.gallery))imgs.push(...rec.gallery);
      const urls=imgs.map(f=>fileUrl(rec,f,"1600x1000"));
      mainImg.src=urls[0]||"assets/placeholder.jpg";
      thumbs.innerHTML=urls.map((u,i)=>`
        <button class="thumb rounded overflow-hidden border ${i===0?'active':''}" data-src="${u}">
          <img src="${u.replace('1600x1000','900x600')}" class="w-full h-16 object-cover">
        </button>`).join("");
      thumbs.querySelectorAll('.thumb').forEach(b=>{
        b.addEventListener('click',()=>{
          mainImg.src=b.dataset.src;
          thumbs.querySelectorAll('.thumb').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
        });
      });

      // specs
      const specMap={
        "Brand":rec.Brand,
        "Model":rec.Model,
        "Year":rec.Year,
        "Condition":rec.Condition,
        "Status":rec.Status,
        "Length (ft)":rec.Size,
        "Berths":rec.berths,
        "Suspension":rec.suspension,
        "Tare (kg)":rec.tare_kg,
        "ATM (kg)":rec.atm_kg,
        "Solar (W)":rec.solar_watts,
        "Battery (Ah)":rec.battery_ah,
        "Chassis":rec.Chassis
      };
      specsEl.innerHTML=Object.entries(specMap)
        .filter(([_,v])=>v!==undefined&&v!==null&&String(v).trim()!=='')
        .map(([k,v])=>`<dt class="text-slate-500">${k}</dt><dd class="text-slate-800">${v}</dd>`)
        .join("");

      // features (optional future field)
      featuresEl.innerHTML="Additional_Features";

      // email link
      enquireEl.href=`mailto:reception@caravanstas.com.au?subject=${encodeURIComponent('Enquiry: '+title)}`;
    }

    loadCaravan();
  </script>
</body>
</html>
