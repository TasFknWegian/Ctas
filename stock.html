<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stock — Caravans Tasmania</title>
  <meta name="description" content="In-stock caravans in Youngtown, Launceston. View New Age and Highclere models."/>
  <link rel="icon" href="assets/ct_logo_email_600_white.png"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { scroll-behavior: smooth; }
    .nav-backdrop{backdrop-filter:saturate(180%) blur(8px);-webkit-backdrop-filter:saturate(180%) blur(8px)}
  </style>
</head>
<body class="bg-white text-slate-800">
  <div class="w-full bg-slate-900 text-white text-sm">
    <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between">
      <a href="tel:+61363437287" class="hover:underline">Call (03) 6343 7287</a>
      <div class="space-x-4 hidden sm:block">
        <a href="https://www.facebook.com/caravanstasmania/" target="_blank" rel="noopener" class="hover:underline">Facebook</a>
      </div>
    </div>
  </div>

  <header class="sticky top-0 z-40 bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <a href="index.html#home" class="flex items-center space-x-3">
          <img src="assets/ct_logo_email_600_white.png" alt="Caravans Tasmania" class="h-12 md:h-14 w-auto object-contain"/>
        </a>
        <nav class="hidden md:flex items-center space-x-6">
          <a href="index.html#home">Home</a>
          <a href="stock.html" class="font-semibold text-slate-900">Stock</a>
          <a href="index.html#services">Services</a>
          <a href="index.html#about">About</a>
          <a href="index.html#contact">Contact</a>
        </nav>
        <button id="menuBtn" class="md:hidden p-2 rounded hover:bg-slate-100" aria-label="Open Menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
      </div>
    </div>
    <div id="mobileNav" class="md:hidden hidden border-t border-slate-200 bg-white">
      <nav class="max-w-7xl mx-auto px-4 py-4 grid gap-3">
        <a href="index.html#home" class="py-2">Home</a>
        <a href="stock.html" class="py-2">Stock</a>
        <a href="index.html#services" class="py-2">Services</a>
        <a href="index.html#about" class="py-2">About</a>
        <a href="index.html#contact" class="py-2">Contact</a>
      </nav>
    </div>
  </header>

  <section class="py-10 bg-slate-50 border-b">
    <div class="max-w-7xl mx-auto px-4">
      <h1 class="text-3xl font-semibold">In-stock caravans</h1>
      <p class="mt-2 text-slate-600">Ready for viewing at 389 Hobart Road, Youngtown TAS 7249.</p>
    </div>
  </section>

  <section class="py-6">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid gap-3 md:grid-cols-6">
        <input id="q" type="search" placeholder="Search title, feature, length…" class="md:col-span-2 border rounded-lg px-3 py-2">
        <select id="category" class="border rounded-lg px-3 py-2">
          <option value="">All categories</option>
          <option value="new">New</option>
          <option value="used">Used</option>
        </select>
        <select id="sold" class="border rounded-lg px-3 py-2">
          <option value="">Any status</option>
          <option value="available">Available</option>
          <option value="sold">Sold</option>
        </select>
        <select id="sort" class="border rounded-lg px-3 py-2">
          <option value="newest">Newest</option>
          <option value="price-asc">Price: Low → High</option>
          <option value="price-desc">Price: High → Low</option>
        </select>
      </div>
      <div class="mt-3 text-sm text-slate-600"><span id="count">0</span> units</div>
    </div>
  </section>

  <main class="py-8">
    <div class="max-w-7xl mx-auto px-4">
      <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <p id="empty" class="hidden text-slate-500 text-center py-16">No results. Try clearing filters or searching a different term.</p>
    </div>
  </main>

  <footer class="bg-slate-900 text-slate-200 mt-10">
    <div class="max-w-7xl mx-auto px-4 py-12 grid md:grid-cols-4 gap-8">
      <div>
        <h4 class="font-semibold">Caravans Tasmania</h4>
        <p class="text-sm text-slate-400 mt-2">Sales & Service: 389 Hobart Road, Youngtown TAS 7249</p>
        <p class="mt-2 text-sm">Phone: <a class="underline" href="tel:+61363437287">(03) 6343 7287</a><br/>Email: <a class="underline" href="mailto:reception@caravanstas.com.au">reception@caravanstas.com.au</a></p>
      </div>
      <div>
        <h5 class="font-semibold">Hours</h5>
        <p class="text-sm text-slate-400 mt-2">Mon–Fri 8:30–5:00<br/>Sat 8:00–12:00</p>
      </div>
      <div class="md:col-span-2">
        <h5 class="font-semibold">Need details?</h5>
        <p class="text-sm text-slate-300 mt-2">Click any unit to view full specs, photos and contact options.</p>
      </div>
    </div>
    <div class="border-t border-slate-700">
      <div class="max-w-7xl mx-auto px-4 py-6 text-sm flex items-center justify-between">
        <p>© <span id="year"></span> Caravans Tasmania. All rights reserved.</p>
        <div class="space-x-4">
          <a href="index.html#contact" class="hover:underline">Contact</a>
          <a href="https://maps.google.com/?q=389%20Hobart%20Road,%20Youngtown%20TAS%207249" target="_blank" rel="noopener" class="hover:underline">Directions</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const menuBtn = document.getElementById('menuBtn');
    const mobileNav = document.getElementById('mobileNav');
    function toggleNav(open){const isOpen=open??mobileNav.classList.contains('hidden');mobileNav.classList.toggle('hidden',!isOpen);menuBtn?.setAttribute('aria-expanded',String(isOpen));}
    menuBtn?.addEventListener('click',()=>toggleNav());
    mobileNav?.querySelectorAll('a').forEach(a=>a.addEventListener('click',()=>toggleNav(false)));
    document.addEventListener('keydown',e=>{if(e.key==='Escape')toggleNav(false);});

    const qEl=document.getElementById('q');
    const catEl=document.getElementById('category');
    const soldEl=document.getElementById('sold');
    const sortEl=document.getElementById('sort');
    const grid=document.getElementById('grid');
    const countEl=document.getElementById('count');
    const emptyEl=document.getElementById('empty');

    const SHEET_CSV_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vSPtHlwJq_gTjl71aIzldiDbkZ6diF0akBbKqiuGq3gwxatmuiE0n3Nv_x8E57LPz-rG0hIyb4_SjXm/pub?output=csv';

    function parseCSV(text){
      const rows=[];let i=0,field='',row=[],inQuotes=false;
      while(i<text.length){
        const c=text[i],n=text[i+1];
        if(inQuotes){
          if(c=='"'&&n=='"'){field+='"';i+=2;continue;}
          if(c=='"'){inQuotes=false;i++;continue;}
          field+=c;i++;continue;
        }else{
          if(c=='"'){inQuotes=true;i++;continue;}
          if(c==','){row.push(field);field='';i++;continue;}
          if(c=='\n'||c=='\r'){if(field.length||row.length){row.push(field);rows.push(row);}field='';row=[];i++;if(c=='\r'&&n=='\n')i++;continue;}
          field+=c;i++;
        }
      }
      if(field.length||row.length){row.push(field);rows.push(row);}
      return rows;
    }

    function mapRowsToItems(rows){
      const [header,...data]=rows;
      if(!header) return [];
      const idx=Object.fromEntries(header.map((h,i)=>[h.trim(),i]));
      const get=(r,name)=>(r[idx[name]]||'').trim();
      return data
        .filter(r=>r.length && get(r,'id'))
        .map(r=>{
          const images=[get(r,'image_1'),get(r,'image_2')].filter(Boolean);
          const price=get(r,'price');
          return{
            id:get(r,'id'),
            title:get(r,'title'),
            price:price?Number(price.replace(/[^\d.]/g,'')):null,
            category:get(r,'category')?.toLowerCase(),
            sold:/^true$/i.test(get(r,'sold')),
            type:get(r,'type'),
            length:get(r,'length'),
            sleeps:get(r,'sleeps'),
            axleConfiguration:get(r,'axleConfiguration'),
            suspension:get(r,'suspension'),
            weight:get(r,'weight'),
            registered:/^true$/i.test(get(r,'registered')),
            description:get(r,'description_html'),
            thumbnail:get(r,'thumbnail')||images[0]||'',
            images,
            date_created:new Date().toISOString()
          };
        });
    }

    const currency=n=>{
      if(n===null||n===undefined||n==='')return'POA';
      const num=typeof n==='number'?n:parseFloat(n);
      if(isNaN(num))return'POA';
      return num.toLocaleString('en-AU',{style:'currency',currency:'AUD',maximumFractionDigits:0});
    };

    const fileUrl=(url)=>url && /^https?:\/\//i.test(url) ? url : (url? (url.startsWith('/')?url:'/'+url) : 'assets/placeholder.jpg');

    function thumbSrc(it){
      if(it.thumbnail) return fileUrl(it.thumbnail);
      if(Array.isArray(it.images)&&it.images[0]) return fileUrl(it.images[0]);
      return 'assets/placeholder.jpg';
    }

    function matches(it){
      const q=(qEl.value||'').toLowerCase().trim();
      if(catEl.value&&(it.category||'')!==catEl.value) return false;
      if(soldEl.value){
        const s=it.sold?'sold':'available';
        if(s!==soldEl.value) return false;
      }
      if(q){
        const tmp=document.createElement('div'); tmp.innerHTML=it.description||'';
        const hay=[it.title,it.length,it.suspension,it.axleConfiguration,it.type,it.category,it.id,tmp.textContent||'',(it.sleeps??'')].join(' ').toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    }

    function sortList(list){
      switch(sortEl.value){
        case 'price-asc':  return list.slice().sort((a,b)=>(parseFloat(a.price)||1e12)-(parseFloat(b.price)||1e12));
        case 'price-desc': return list.slice().sort((a,b)=>(parseFloat(b.price)||-1)-(parseFloat(a.price)||-1));
        default:           return list.slice().sort((a,b)=>new Date(b.date_created||0)-new Date(a.date_created||0));
      }
    }

    function cardHTML(it){
      const href='caravan.html?id='+encodeURIComponent(it.id);
      const img=thumbSrc(it);
      const meta=[it.length,it.sleeps?`${it.sleeps} berth`:'',it.axleConfiguration].filter(Boolean).join(' • ');
      return `
        <a href="${href}" class="rounded-xl border border-slate-200 overflow-hidden bg-white shadow-sm block">
          <div class="relative">
            <img src="${img}" alt="${it.title||''}" class="w-full h-48 object-cover">
            <div class="absolute top-2 left-2 flex gap-2">
              ${it.category?`<span class="inline-block text-xs px-2 py-1 rounded bg-white/90 border">${it.category==='new'?'New':'Used'}</span>`:''}
              ${it.sold?`<span class="inline-block text-xs px-2 py-1 rounded bg-red-600 text-white">Sold</span>`:''}
            </div>
          </div>
          <div class="p-5">
            <h3 class="font-semibold">${it.title||'(Untitled)'}</h3>
            <p class="mt-1 text-sm text-slate-600">${meta}</p>
            <p class="mt-2 font-semibold">${currency(it.price)}</p>
          </div>
        </a>`;
    }

    function render(list){
      const filtered=sortList(list.filter(matches));
      grid.innerHTML=filtered.map(cardHTML).join('');
      countEl.textContent=filtered.length;
      emptyEl.classList.toggle('hidden',filtered.length>0);
    }

    fetch(SHEET_CSV_URL,{cache:'no-store'})
      .then(r=>r.text())
      .then(csv=>{
        const items=mapRowsToItems(parseCSV(csv));
        window.__STOCK=items;
        render(items);
      })
      .catch(err=>{
        console.error('Sheet load error:',err);
        emptyEl.classList.remove('hidden');
        emptyEl.textContent='Could not load stock from Google Sheets.';
      });

    qEl.addEventListener('input',()=>render(window.__STOCK||[]));
    catEl.addEventListener('change',()=>render(window.__STOCK||[]));
    soldEl.addEventListener('change',()=>render(window.__STOCK||[]));
    sortEl.addEventListener('change',()=>render(window.__STOCK||[]));
  </script>
</body>
</html>
