// ====== PocketBase config (YOUR schema) ======
const PB_BASE = "http://101.187.178.19:8090/api/collections/caravans/records";   // or your LAN/DDNS/HTTPS URL
const PB_COLLECTION = "caravans";          // <-- note the capital C

function pbFileUrl(base, rec, file, size = "900x600") {
  if (!file) return "assets/placeholder.jpg";
  const col = rec.collectionId || rec.collectionName || PB_COLLECTION;
  return `${base}/api/files/${encodeURIComponent(col)}/${encodeURIComponent(rec.id)}/${encodeURIComponent(file)}?thumb=${size}`;
}

// Map YOUR fields to the list card shape the page expects
function mapPBToItem(rec) {
  // Your fields are Title/Brand/Model/Year/Price/Condition/Status/Main_image/gallery/Size/berths/tare_kg/atm_kg/suspension
  const statusRaw = (rec.Status || "").toString().toLowerCase();     // "available" / "sold" / etc
  const conditionRaw = (rec.Condition || "").toString().toLowerCase(); // "new" / "used" / "demo"
  const sold = statusRaw === "sold";
  const length = rec.Size ? `${rec.Size} ft` : "";                    // Your "Size" looks like feet

  // Image: prefer Main_image, fallback to first in gallery
  const hero = rec.Main_image || (Array.isArray(rec.gallery) && rec.gallery[0]);
  const thumb = hero ? pbFileUrl(PB_BASE, rec, hero) : "assets/placeholder.jpg";

  // Price: ensure a number or null
  const price =
    typeof rec.Price === "number"
      ? rec.Price
      : parseFloat((rec.Price || "").toString().replace(/[^\d.]/g, "")) || null;

  return {
    id: rec.id,
    title: rec.Title || [rec.Brand, rec.Model].filter(Boolean).join(" ") || "(Untitled)",
    price,
    category: conditionRaw, // used by your "New/Used" filter
    sold,                   // used by your "Available/Sold" filter
    type: rec.Type || "",
    length,
    sleeps: rec.berths || "",
    axleConfiguration: rec.axleConfiguration || rec.Axle || "",
    suspension: rec.suspension || "",
    weight: rec.weight || "",
    registered: !!rec.registered,
    description: rec.description || "",
    thumbnail: thumb,
    images: [
      hero ? pbFileUrl(PB_BASE, rec, hero, "1600x1000") : null,
      ...(Array.isArray(rec.gallery) ? rec.gallery.map(f => pbFileUrl(PB_BASE, rec, f, "1600x1000")) : [])
    ].filter(Boolean),
    date_created: rec.created || new Date().toISOString(),
  };
}

// Fetch YOUR records (public list). You can filter at PB level or do it client-side.
async function fetchCaravansPB() {
  // If you set List/View rules, you can add a PB-side filter here, e.g. Status="Available"
  // const filter = encodeURIComponent('Status="Available"');
  const params = new URLSearchParams({
    perPage: "200",
    sort: "-created"
    // , filter
  });
  const url = `${PB_BASE}/api/collections/${encodeURIComponent(PB_COLLECTION)}/records?` + params.toString();
  const r = await fetch(url, { headers: { "Accept": "application/json" }, cache: "no-store" });
  if (!r.ok) throw new Error(`PocketBase fetch failed: ${r.status}`);
  const data = await r.json();
  const records = data.items || data.records || [];
  return records.map(mapPBToItem);
}
