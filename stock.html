<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stock — Caravans Tasmania</title>
  <meta name="description" content="In-stock caravans in Youngtown, Launceston. View New Age and Highclere models."/>
  <link rel="icon" href="assets/ct_logo_email_600_white.png"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { scroll-behavior: smooth; }
    .nav-backdrop { backdrop-filter: saturate(180%) blur(8px); -webkit-backdrop-filter: saturate(180%) blur(8px); }
  </style>
</head>
<script>
(async ()=>{
  const API = 'https://admin.caravanstasmania.com.au';
  const url = API + '/items/Caravans?fields=id,title,thumbnail,images.directus_files_id.id&limit=1';

  const banner = msg => {
    let el = document.getElementById('directus-debug');
    if (!el) {
      el = document.createElement('div');
      el.id = 'directus-debug';
      el.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:#fee;color:#900;padding:8px 12px;font:12px/1.4 system-ui;z-index:9999;border-top:1px solid #f99';
      document.body.appendChild(el);
    }
    el.textContent = msg;
  };

  try {
    // 1) Can we reach the API host at all?
    const health = await fetch(API + '/server/health', {mode:'cors'}).catch(e=>e);
    if (!(health && health.ok)) {
      return banner('Cannot reach Directus health endpoint from this page. Likely CORS or network. Try adding this page origin to CORS and serve over http:// (not file://).');
    }

    // 2) Can we read your Caravans?
    const r = await fetch(url, {mode:'cors', cache:'no-store'}).catch(e=>e);
    if (!(r && r.ok)) {
      const txt = (r && r.text) ? await r.text() : (r && r.message) || 'unknown error';
      return banner(`Directus fetch failed: HTTP ${(r && r.status) || ''} ${(r && r.statusText) || ''} — ${String(txt).slice(0,200)}`);
    }

    const js = await r.json();
    console.log('Caravans sample:', js);
    banner('Directus OK — data received. If cards still don’t render, check your JS paths/field names.');
  } catch (e) {
    console.error(e);
    banner('Network/CORS error talking to Directus. Add your site origin to CORS and serve via http://');
  }
})();
</script>

<body class="bg-white text-slate-800">
  <!-- Top Bar -->
  <div class="w-full bg-slate-900 text-white text-sm">
    <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between">
      <a href="tel:+61363437287" class="hover:underline">Call (03) 6343 7287</a>
      <div class="space-x-4 hidden sm:block">
        <a href="https://www.facebook.com/caravanstasmania/" target="_blank" rel="noopener" class="hover:underline">Facebook</a>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/80 nav-backdrop border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <a href="index.html#home" class="flex items-center space-x-3">
          <img src="assets/ct_logo_email_600_white.png" alt="Caravans Tasmania" class="h-10 w-auto object-contain"/>
          <span class="sr-only">Caravans Tasmania</span>
        </a>
        <nav class="hidden md:flex items-center space-x-6">
          <a href="index.html#home">Home</a>
          <a href="stock.html" class="font-semibold text-slate-900">Stock</a>
          <a href="index.html#services">Services</a>
          <a href="index.html#about">About</a>
          <a href="index.html#contact">Contact</a>
        </nav>
        <button id="menuBtn" class="md:hidden p-2 rounded hover:bg-slate-100" aria-label="Open Menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
      </div>
    </div>
    <div id="mobileNav" class="md:hidden hidden border-t border-slate-200 bg-white">
      <nav class="max-w-7xl mx-auto px-4 py-4 grid gap-3">
        <a href="index.html#home" class="py-2">Home</a>
        <a href="stock.html" class="py-2">Stock</a>
        <a href="index.html#services" class="py-2">Services</a>
        <a href="index.html#about" class="py-2">About</a>
        <a href="index.html#contact" class="py-2">Contact</a>
      </nav>
    </div>
  </header>

  <!-- Page header -->
  <section class="py-10 bg-slate-50 border-b">
    <div class="max-w-7xl mx-auto px-4">
      <h1 class="text-3xl font-semibold">In-stock caravans</h1>
      <p class="mt-2 text-slate-600">Ready for viewing at 389 Hobart Road, Youngtown TAS 7249.</p>
    </div>
  </section>

  <!-- Filters -->
  <section class="py-6">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid gap-3 md:grid-cols-6">
        <input id="q" type="search" placeholder="Search title, feature, length…" class="md:col-span-2 border rounded-lg px-3 py-2">
        <select id="category" class="border rounded-lg px-3 py-2">
          <option value="">All categories</option>
          <option value="new">New</option>
          <option value="used">Used</option>
        </select>
        <select id="sold" class="border rounded-lg px-3 py-2">
          <option value="">Any status</option>
          <option value="available">Available</option>
          <option value="sold">Sold</option>
        </select>
        <select id="sort" class="border rounded-lg px-3 py-2">
          <option value="newest">Newest</option>
          <option value="price-asc">Price: Low → High</option>
          <option value="price-desc">Price: High → Low</option>
        </select>
      </div>
      <div class="mt-3 text-sm text-slate-600"><span id="count">0</span> units</div>
    </div>
  </section>

  <!-- Grid -->
  <main class="py-8">
    <div class="max-w-7xl mx-auto px-4">
      <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <p id="empty" class="hidden text-slate-500 text-center py-16">No results. Try clearing filters or searching a different term.</p>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-slate-900 text-slate-200 mt-10">
    <div class="max-w-7xl mx-auto px-4 py-12 grid md:grid-cols-4 gap-8">
      <div>
        <h4 class="font-semibold">Caravans Tasmania</h4>
        <p class="text-sm text-slate-400 mt-2">Sales & Service: 389 Hobart Road, Youngtown TAS 7249</p>
        <p class="mt-2 text-sm">Phone: <a class="underline" href="tel:+61363437287">(03) 6343 7287</a><br/>Email: <a class="underline" href="mailto:reception@caravanstas.com.au">reception@caravanstas.com.au</a></p>
      </div>
      <div>
        <h5 class="font-semibold">Hours</h5>
        <p class="text-sm text-slate-400 mt-2">Mon–Fri 8:30–5:00<br/>Sat 8:00–12:00</p>
      </div>
      <div class="md:col-span-2">
        <h5 class="font-semibold">Need details?</h5>
        <p class="text-sm text-slate-300 mt-2">Click any unit to view full specs, photos and contact options.</p>
      </div>
    </div>
    <div class="border-t border-slate-700">
      <div class="max-w-7xl mx-auto px-4 py-6 text-sm flex items-center justify-between">
        <p>© <span id="year"></span> Caravans Tasmania. All rights reserved.</p>
        <div class="space-x-4">
          <a href="index.html#contact" class="hover:underline">Contact</a>
          <a href="https://maps.google.com/?q=389%20Hobart%20Road,%20Youngtown%20TAS%207249" target="_blank" rel="noopener" class="hover:underline">Directions</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // ---------- CONFIG ----------
    const API = 'https://admin.caravanstasmania.com.au';
    const COLLECTION = 'Caravans';        // Capital C (confirmed)
    const PRESET_THUMB = 'thumb';         // Use Directus image preset if you've created it; else fallback width

    // ---------- COMMON ----------
    document.getElementById('year').textContent = new Date().getFullYear();
    const menuBtn = document.getElementById('menuBtn');
    const mobileNav = document.getElementById('mobileNav');
    function toggleNav(open){ const isOpen=open??mobileNav.classList.contains('hidden'); mobileNav.classList.toggle('hidden',!isOpen); menuBtn?.setAttribute('aria-expanded',String(isOpen)); }
    menuBtn?.addEventListener('click',()=>toggleNav());
    mobileNav?.querySelectorAll('a').forEach(a=>a.addEventListener('click',()=>toggleNav(false)));
    document.addEventListener('keydown',e=>{ if(e.key==='Escape') toggleNav(false) });

    // ---------- UI ----------
    const qEl = document.getElementById('q'),
          catEl = document.getElementById('category'),
          soldEl = document.getElementById('sold'),
          sortEl = document.getElementById('sort');
    const grid = document.getElementById('grid'),
          countEl = document.getElementById('count'),
          emptyEl = document.getElementById('empty');

    const currency = n => {
      if (n === null || n === undefined || n === '') return 'POA';
      const num = typeof n === 'number' ? n : parseFloat(n);
      if (isNaN(num)) return 'POA';
      return num.toLocaleString('en-AU',{style:'currency',currency:'AUD',maximumFractionDigits:0});
    };

    function fileUrl(id, preset = PRESET_THUMB){
      if (!id) return 'assets/placeholder.jpg';
      return preset ? `${API}/assets/${id}?key=${preset}` : `${API}/assets/${id}?width=800&fit=cover`;
    }

    function matches(it){
      const q = (qEl.value||'').toLowerCase().trim();
      if (catEl.value && (it.category||'') !== catEl.value) return false;
      if (soldEl.value) {
        const s = it.sold ? 'sold' : 'available';
        if (s !== soldEl.value) return false;
      }
      if (q){
        const desc = (it.description_text || '').toLowerCase();
        const hay = [it.title, it.length, it.suspension, it.axleConfiguration, it.type, it.category, it.id, desc, (it.sleeps ?? '')].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    }
    function sortList(list){
      switch (sortEl.value){
        case 'price-asc':  return list.slice().sort((a,b)=>(parseFloat(a.price)||1e12)-(parseFloat(b.price)||1e12));
        case 'price-desc': return list.slice().sort((a,b)=>(parseFloat(b.price)||-1)-(parseFloat(a.price)||-1));
        default:           return list.slice().sort((a,b)=> new Date(b.date_created||0) - new Date(a.date_created||0));
      }
    }

    function cardHTML(it){
      const href='caravan.html?id='+encodeURIComponent(it.id);
      const thumb = fileUrl(it.thumbnail || it._firstPhotoId);
      const metaBits = [it.length, it.sleeps ? `${it.sleeps} berth` : '', it.axleConfiguration].filter(Boolean).join(' • ');
      return `
        <a href="${href}" class="rounded-xl border border-slate-200 overflow-hidden bg-white shadow-sm block">
          <div class="relative">
            <img src="${thumb}" alt="${it.title || ''}" class="w-full h-48 object-cover">
            <div class="absolute top-2 left-2 flex gap-2">
              ${it.category?`<span class="inline-block text-xs px-2 py-1 rounded bg-white/90 border">${it.category === 'new' ? 'New' : 'Used'}</span>`:''}
              ${it.sold?`<span class="inline-block text-xs px-2 py-1 rounded bg-red-600 text-white">Sold</span>`:''}
            </div>
          </div>
          <div class="p-5">
            <h3 class="font-semibold">${it.title || '(Untitled)'}</h3>
            <p class="mt-1 text-sm text-slate-600">${metaBits}</p>
            <p class="mt-2 font-semibold">${currency(it.price)}</p>
          </div>
        </a>
      `;
    }

    function render(list){
      const filtered = sortList(list.filter(matches));
      grid.innerHTML = filtered.map(cardHTML).join('');
      countEl.textContent = filtered.length;
      emptyEl.classList.toggle('hidden', filtered.length>0);
    }

    // ---------- FETCH ----------
<script>
  // Build image URL for Directus files (works fine in <img> without CORS)
  const fileUrl = (id) => id ? `https://admin.caravanstasmania.com.au/assets/${id}?width=800&fit=cover` : 'assets/placeholder.jpg';

  const fieldsUsed = ['id','title','price','category','type','registered','sleeps','weight','length','suspension','axleConfiguration','sold','thumbnail','date_created','images','description'];

  fetch('/assets/stock.json', { cache:'no-store' })
    .then(r => r.json())
    .then(data => {
      const items = (data?.data || data || []).map(it => {
        const photos = Array.isArray(it.images) ? it.images : [];
        const firstId = photos[0]?.directus_files_id?.id || photos[0]?.id || it.thumbnail || null;
        const tmp = document.createElement('div'); tmp.innerHTML = it.description || '';
        const descText = tmp.textContent || tmp.innerText || '';
        return { ...it, _firstPhotoId:firstId, description_text: descText };
      });

      window.__STOCK = items;

      // Reuse your existing helpers (card render, filters, etc.)
      (function initFilters(){
        const qEl = document.getElementById('q');
        const catEl = document.getElementById('category');
        const soldEl = document.getElementById('sold');
        const sortEl = document.getElementById('sort');
        const grid = document.getElementById('grid');
        const countEl = document.getElementById('count');
        const emptyEl = document.getElementById('empty');

        const currency = n => {
          if (n === null || n === undefined || n === '') return 'POA';
          const num = typeof n === 'number' ? n : parseFloat(n);
          if (isNaN(num)) return 'POA';
          return num.toLocaleString('en-AU',{style:'currency',currency:'AUD',maximumFractionDigits:0});
        };

        function matches(it){
          const q = (qEl.value||'').toLowerCase().trim();
          if (catEl.value && (it.category||'') !== catEl.value) return false;
          if (soldEl.value) {
            const s = it.sold ? 'sold' : 'available';
            if (s !== soldEl.value) return false;
          }
          if (q){
            const hay = [
              it.title, it.length, it.suspension, it.axleConfiguration, it.type, it.category, it.id, it.description_text, (it.sleeps ?? '')
            ].join(' ').toLowerCase();
            if (!hay.includes(q)) return false;
          }
          return true;
        }
        function sortList(list){
          switch (sortEl.value){
            case 'price-asc':  return list.slice().sort((a,b)=>(parseFloat(a.price)||1e12)-(parseFloat(b.price)||1e12));
            case 'price-desc': return list.slice().sort((a,b)=>(parseFloat(b.price)||-1)-(parseFloat(a.price)||-1));
            default:           return list.slice().sort((a,b)=> new Date(b.date_created||0) - new Date(a.date_created||0));
          }
        }
        function cardHTML(it){
          const href='caravan.html?id='+encodeURIComponent(it.id);
          const thumb = fileUrl(it._firstPhotoId);
          const metaBits = [it.length, it.sleeps ? `${it.sleeps} berth` : '', it.axleConfiguration].filter(Boolean).join(' • ');
          return `
            <a href="${href}" class="rounded-xl border border-slate-200 overflow-hidden bg-white shadow-sm block">
              <div class="relative">
                <img src="${thumb}" alt="${it.title || ''}" class="w-full h-48 object-cover">
                <div class="absolute top-2 left-2 flex gap-2">
                  ${it.category?`<span class="inline-block text-xs px-2 py-1 rounded bg-white/90 border">${it.category === 'new' ? 'New' : 'Used'}</span>`:''}
                  ${it.sold?`<span class="inline-block text-xs px-2 py-1 rounded bg-red-600 text-white">Sold</span>`:''}
                </div>
              </div>
              <div class="p-5">
                <h3 class="font-semibold">${it.title || '(Untitled)'}</h3>
                <p class="mt-1 text-sm text-slate-600">${metaBits}</p>
                <p class="mt-2 font-semibold">${currency(it.price)}</p>
              </div>
            </a>
          `;
        }
        function render(list){
          const filtered = sortList(list.filter(matches));
          grid.innerHTML = filtered.map(cardHTML).join('');
          countEl.textContent = filtered.length;
          emptyEl.classList.toggle('hidden', filtered.length>0);
        }

        render(items);
        qEl.addEventListener('input', ()=>render(items));
        catEl.addEventListener('change', ()=>render(items));
        soldEl.addEventListener('change', ()=>render(items));
        sortEl.addEventListener('change', ()=>render(items));
      })();
    })
    .catch(err => {
      console.error(err);
      const emptyEl = document.getElementById('empty');
      emptyEl.classList.remove('hidden');
      emptyEl.textContent = 'No stock file found (/assets/stock.json).';
    });
</script>
</body>
</html>

