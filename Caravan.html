<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Caravan — Caravans Tasmania</title>
  <meta name="description" content="Caravan details, photos and specifications."/>
  <link rel="icon" href="assets/ct_logo_email_600_white.png"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { scroll-behavior: smooth; }
    .nav-backdrop { backdrop-filter: saturate(180%) blur(8px); -webkit-backdrop-filter: saturate(180%) blur(8px); }
  </style>
</head>
<body class="bg-white text-slate-800">
  <!-- Top Bar -->
  <div class="w-full bg-slate-900 text-white text-sm">
    <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between">
      <a href="tel:+61363437287" class="hover:underline">Call (03) 6343 7287</a>
      <div class="space-x-4 hidden sm:block">
        <a href="https://www.facebook.com/caravanstasmania/" target="_blank" rel="noopener" class="hover:underline">Facebook</a>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/80 nav-backdrop border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <a href="index.html#home" class="flex items-center space-x-3">
          <img src="assets/ct_logo_email_600_white.png" alt="Caravans Tasmania" class="h-10 w-auto object-contain"/>
          <span class="sr-only">Caravans Tasmania</span>
        </a>
        <nav class="hidden md:flex items-center space-x-6">
          <a href="index.html#home">Home</a>
          <a href="stock.html">Stock</a>
          <a href="index.html#services">Services</a>
          <a href="index.html#about">About</a>
          <a href="index.html#contact">Contact</a>
        </nav>
        <button id="menuBtn" class="md:hidden p-2 rounded hover:bg-slate-100" aria-label="Open Menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
      </div>
    </div>
    <div id="mobileNav" class="md:hidden hidden border-t border-slate-200 bg-white">
      <nav class="max-w-7xl mx-auto px-4 py-4 grid gap-3">
        <a href="index.html#home" class="py-2">Home</a>
        <a href="stock.html" class="py-2">Stock</a>
        <a href="index.html#services" class="py-2">Services</a>
        <a href="index.html#about" class="py-2">About</a>
        <a href="index.html#contact" class="py-2">Contact</a>
      </nav>
    </div>
  </header>

  <!-- Content -->
  <main class="py-8">
    <div class="max-w-7xl mx-auto px-4">
      <a href="stock.html" class="text-sm text-slate-600 hover:underline">&larr; Back to stock</a>

      <div id="error" class="hidden mt-6 p-4 rounded-lg border border-red-200 bg-red-50 text-red-800"></div>

      <section id="hero" class="mt-4 grid lg:grid-cols-2 gap-8">
        <!-- Image gallery -->
        <div>
          <div class="aspect-video overflow-hidden rounded-xl border border-slate-200 bg-slate-100">
            <img id="heroImg" class="w-full h-full object-cover" alt="">
          </div>
          <div id="thumbs" class="mt-3 grid grid-cols-5 gap-2"></div>
        </div>

        <!-- Summary -->
        <div>
          <h1 id="title" class="text-2xl font-semibold">Loading…</h1>
          <div class="mt-2 flex gap-2" id="badges"></div>
          <p id="price" class="mt-3 text-2xl font-semibold"></p>

          <ul id="meta" class="mt-4 grid grid-cols-2 gap-2 text-sm text-slate-700"></ul>

          <div class="mt-6 flex gap-3">
            <a href="index.html#contact" class="px-4 py-2 rounded-lg bg-slate-900 text-white">Enquire</a>
            <a id="directions" href="https://maps.google.com/?q=389%20Hobart%20Road,%20Youngtown%20TAS%207249" target="_blank" rel="noopener" class="px-4 py-2 rounded-lg border border-slate-300">Get directions</a>
          </div>
        </div>
      </section>

      <!-- Description -->
      <section class="mt-10">
        <h2 class="text-xl font-semibold">Description</h2>
        <div id="desc" class="prose prose-slate max-w-none mt-3"></div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-slate-900 text-slate-200 mt-12">
    <div class="max-w-7xl mx-auto px-4 py-12 grid md:grid-cols-4 gap-8">
      <div>
        <h4 class="font-semibold">Caravans Tasmania</h4>
        <p class="text-sm text-slate-400 mt-2">Sales & Service: 389 Hobart Road, Youngtown TAS 7249</p>
        <p class="mt-2 text-sm">Phone: <a class="underline" href="tel:+61363437287">(03) 6343 7287</a><br/>Email: <a class="underline" href="mailto:reception@caravanstas.com.au">reception@caravanstas.com.au</a></p>
      </div>
      <div>
        <h5 class="font-semibold">Hours</h5>
        <p class="text-sm text-slate-400 mt-2">Mon–Fri 8:30–5:00<br/>Sat 8:00–12:00</p>
      </div>
      <div class="md:col-span-2">
        <h5 class="font-semibold">Ready to view?</h5>
        <p class="text-sm text-slate-300 mt-2">Drop in or call to arrange an appointment.</p>
      </div>
    </div>
    <div class="border-t border-slate-700">
      <div class="max-w-7xl mx-auto px-4 py-6 text-sm flex items-center justify-between">
        <p>© <span id="year"></span> Caravans Tasmania. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    // Footer year + mobile nav
    document.getElementById('year').textContent = new Date().getFullYear();
    const menuBtn = document.getElementById('menuBtn');
    const mobileNav = document.getElementById('mobileNav');
    function toggleNav(open){ const isOpen=open??mobileNav.classList.contains('hidden'); mobileNav.classList.toggle('hidden',!isOpen); menuBtn?.setAttribute('aria-expanded',String(isOpen)); }
    menuBtn?.addEventListener('click',()=>toggleNav());
    mobileNav?.querySelectorAll('a').forEach(a=>a.addEventListener('click',()=>toggleNav(false)));
    document.addEventListener('keydown',e=>{ if(e.key==='Escape') toggleNav(false) });

    // -------- Details page logic --------
    const API = 'https://admin.caravanstasmania.com.au';

    const directusFileUrl = (id, w=1200) => id ? `${API}/assets/${id}?width=${w}&fit=cover` : null;
    const currency = n => {
      if (n === null || n === undefined || n === '') return 'POA';
      const num = typeof n === 'number' ? n : parseFloat(n);
      if (isNaN(num)) return 'POA';
      return num.toLocaleString('en-AU',{style:'currency',currency:'AUD',maximumFractionDigits:0});
    };
    const ensureLeadingSlash = p => /^https?:\/\//i.test(p) ? p : (p?.startsWith('/') ? p : '/'+p);

    const params = new URLSearchParams(location.search);
    const wantedId = params.get('id');

    const el = {
      error: document.getElementById('error'),
      title: document.getElementById('title'),
      price: document.getElementById('price'),
      badges: document.getElementById('badges'),
      meta: document.getElementById('meta'),
      desc: document.getElementById('desc'),
      hero: document.getElementById('heroImg'),
      thumbs: document.getElementById('thumbs'),
    };

    function showError(msg){
      el.error.textContent = msg;
      el.error.classList.remove('hidden');
      document.title = 'Not found — Caravans Tasmania';
    }

    if (!wantedId){
      showError('No caravan id provided.');
    } else {
      fetch('/assets/stock.json', { cache:'no-store' })
        .then(r => r.json())
        .then(data => {
          const rows = Array.isArray(data?.data) ? data.data : (Array.isArray(data) ? data : []);
          const item = rows.find(x => String(x.id) === String(wantedId));
          if (!item) {
            showError('Caravan not found. It may have been removed or the link is incorrect.');
            return;
          }

          // Title / price
          el.title.textContent = item.title || 'Untitled caravan';
          el.price.textContent = currency(item.price);
          document.title = (item.title || 'Caravan') + ' — Caravans Tasmania';

          // Badges
          el.badges.innerHTML = `
            ${item.category ? `<span class="inline-block text-xs px-2 py-1 rounded bg-slate-100 border">${item.category === 'new' ? 'New' : 'Used'}</span>` : ''}
            ${item.sold ? `<span class="inline-block text-xs px-2 py-1 rounded bg-red-600 text-white">Sold</span>` : ''}
          `;

          // Meta list (only show fields that exist)
          const meta = [];
          if (item.length) meta.push(['Length', item.length]);
          if (item.sleeps) meta.push(['Berths', item.sleeps]);
          if (item.axleConfiguration) meta.push(['Axle', item.axleConfiguration]);
          if (item.suspension) meta.push(['Suspension', item.suspension]);
          if (item.weight) meta.push(['Weight', item.weight]);
          if (item.type) meta.push(['Type', item.type]);
          if (item.registered) meta.push(['Registered', item.registered ? 'Yes' : 'No']);
          el.meta.innerHTML = meta.map(([k,v])=>`<li class="flex justify-between border-b py-2"><span class="text-slate-500">${k}</span><span>${v}</span></li>`).join('');

          // Description (supports HTML in JSON)
          const html = item.description || '';
          el.desc.innerHTML = html;

          // Images: support several shapes
          const urls = [];
          // 1) relational images: [{directus_files_id:{id}}] or [{id}]
          if (Array.isArray(item.images)) {
            item.images.forEach(img => {
              const id = img?.directus_files_id?.id || img?.id;
              if (id) urls.push(directusFileUrl(id, 1400));
              // also support img as a raw string url or path
              if (!id && typeof img === 'string') urls.push(ensureLeadingSlash(img));
            });
          }
          // 2) thumbnail as path or id
          if (item.thumbnail) {
            if (typeof item.thumbnail === 'string' && (item.thumbnail.includes('/') || item.thumbnail.includes('.'))) {
              urls.unshift(ensureLeadingSlash(item.thumbnail));
            } else {
              urls.unshift(directusFileUrl(item.thumbnail, 1400));
            }
          }
          // fallback
          if (!urls.length) urls.push('assets/placeholder.jpg');

          // hero + thumbs
          function setHero(src){ el.hero.src = src; }
          setHero(urls[0]);
          el.thumbs.innerHTML = urls.map((u,i)=>`
            <button class="border rounded overflow-hidden ${i===0?'ring-2 ring-slate-900':''}" data-src="${u}">
              <img src="${u}" alt="Photo ${i+1}" class="w-full h-16 object-cover">
            </button>
          `).join('');
          el.thumbs.querySelectorAll('button').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              setHero(btn.dataset.src);
              el.thumbs.querySelectorAll('button').forEach(b=>b.classList.remove('ring-2','ring-slate-900'));
              btn.classList.add('ring-2','ring-slate-900');
            });
          });
        })
        .catch(err => {
          console.error(err);
          showError('Could not load caravan data.');
        });
    }
  </script>
</body>
</html>
