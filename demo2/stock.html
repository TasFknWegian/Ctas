<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stock — Caravans Tasmania</title>
  <meta name="description" content="In-stock caravans in Youngtown, Launceston. View New Age and Highclere models."/>
  <link rel="icon" href="assets/ct_logo_email_600_white.png"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-white text-slate-800">
  <!-- Top bar -->
  <div class="w-full bg-slate-900 text-white text-sm">
    <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between">
      <a href="tel:+61363437287" class="hover:underline">Call (03) 6343 7287</a>
      <div class="space-x-4 hidden sm:block">
        <a href="https://www.facebook.com/caravanstasmania/" target="_blank" rel="noopener" class="hover:underline">Facebook</a>
      </div>
    </div>
  </div>

  <!-- Header / Nav -->
  <header class="sticky top-0 z-40 bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <a href="index.html#home" class="flex items-center space-x-3">
          <!-- Placeholder image for 'assets/ct_logo_email_600_white.png' -->
          <img src="https://placehold.co/56x56/0f172a/ffffff?text=CT" onerror="this.src='assets/ct_logo_email_600_white.png'" alt="Caravans Tasmania" class="h-12 md:h-14 w-auto object-contain rounded-lg"/>
        </a>
        <nav class="hidden md:flex items-center space-x-6">
          <a href="index.html#home">Home</a>
          <a href="stock.html" class="font-semibold text-slate-900">Stock</a>
          <a href="index.html#services">Services</a>
          <a href="index.html#about">About</a>
          <a href="index.html#contact">Contact</a>
        </nav>
        <button id="menuBtn" class="md:hidden p-2 rounded hover:bg-slate-100" aria-label="Open Menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
      </div>
    </div>
    <div id="mobileNav" class="md:hidden hidden border-t border-slate-200 bg-white">
      <nav class="max-w-7xl mx-auto px-4 py-4 grid gap-3">
        <a href="index.html#home" class="py-2">Home</a>
        <a href="stock.html" class="py-2">Stock</a>
        <a href="index.html#services" class="py-2">Services</a>
        <a href="index.html#about" class="py-2">About</a>
        <a href="index.html#contact" class="py-2">Contact</a>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <section class="py-10 bg-slate-50 border-b">
    <div class="max-w-7xl mx-auto px-4">
      <h1 class="text-3xl font-semibold">In-stock caravans</h1>
      <p class="mt-2 text-slate-600">Ready for viewing at 389 Hobart Road, Youngtown TAS 7249.</p>
    </div>
  </section>

  <!-- Filters -->
  <section class="py-6">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid gap-3 md:grid-cols-6">
        <input id="q" type="search" placeholder="Search title, brand, features…" class="md:col-span-2 border rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
        <select id="brand" class="border rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">All brands</option>
        </select>
        <select id="condition" class="border rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">All conditions</option>
          <option value="new">New</option>
          <option value="used">Used</option>
          <option value="demo">Demo</option>
        </select>
        <select id="status" class="border rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">Any status</option>
          <option value="available">Available</option>
          <option value="sold">Sold</option>
        </select>
        <select id="sort" class="border rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="newest">Newest</option>
          <option value="price-asc">Price: Low → High</option>
          <option value="price-desc">Price: High → Low</option>
        </select>
      </div>
      <div class="mt-3 text-sm text-slate-600"><span id="count">0</span> units</div>
    </div>
  </section>

  <!-- Grid -->
  <main class="py-8">
    <div class="max-w-7xl mx-auto px-4">
      <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div id="loading" class="sm:col-span-2 lg:col-span-3 text-center py-16 text-blue-500">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading stock...
        </div>
      </div>
      <p id="empty" class="hidden text-slate-500 text-center py-16">No results. Try clearing filters or searching a different term.</p>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-slate-900 text-slate-200 mt-10">
    <div class="max-w-7xl mx-auto px-4 py-12 grid md:grid-cols-4 gap-8">
      <div>
        <h4 class="font-semibold">Caravans Tasmania</h4>
        <p class="text-sm text-slate-400 mt-2">Sales & Service: 389 Hobart Road, Youngtown TAS 7249</p>
        <p class="mt-2 text-sm">Phone: <a class="underline" href="tel:+61363437287">(03) 6343 7287</a><br/>Email: <a class="underline" href="mailto:reception@caravanstas.com.au">reception@caravanstas.com.au</a></p>
      </div>
      <div>
        <h5 class="font-semibold">Hours</h5>
        <p class="text-sm text-slate-400 mt-2">Mon–Fri 8:30–5:00<br/>Sat 8:00–12:00</p>
      </div>
      <div class="md:col-span-2">
        <h5 class="font-semibold">Need details?</h5>
        <p class="text-sm text-slate-300 mt-2">Click any unit to view full specs, photos and contact options.</p>
      </div>
    </div>
    <div class="border-t border-slate-700">
      <div class="max-w-7xl mx-auto px-4 py-6 text-sm flex items-center justify-between">
        <p>© <span id="year"></span> Caravans Tasmania. All rights reserved.</p>
        <div class="space-x-4">
          <a href="index.html#contact" class="hover:underline">Contact</a>
          <a href="https://maps.google.com/?q=389%20Hobart%20Road,%20Youngtown%20TAS%207249" target="_blank" rel="noopener" class="hover:underline">Directions</a>
        </div>
      </div>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Set Firestore log level for debugging
    setLogLevel('debug');

    // --- Firebase Initialization ---
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // Global App ID and Collection Path (Public Data)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const COLLECTION_PATH = `/artifacts/${appId}/public/data/caravans`;

    // --- header/menu ---
    document.getElementById('year').textContent = new Date().getFullYear();
    const menuBtn = document.getElementById('menuBtn');
    const mobileNav = document.getElementById('mobileNav');
    function toggleNav(open){const isOpen=open??mobileNav.classList.contains('hidden');mobileNav.classList.toggle('hidden',!isOpen);menuBtn?.setAttribute('aria-expanded',String(isOpen));}
    menuBtn?.addEventListener('click',()=>toggleNav());
    mobileNav?.querySelectorAll('a').forEach(a=>a.addEventListener('click',()=>toggleNav(false)));
    document.addEventListener('keydown',e=>{if(e.key==='Escape')toggleNav(false);});

    // UI refs
    const qEl = document.getElementById('q');
    const brandEl = document.getElementById('brand');
    const condEl = document.getElementById('condition');
    const statusEl = document.getElementById('status');
    const sortEl = document.getElementById('sort');
    const grid = document.getElementById('grid');
    const loadingEl = document.getElementById('loading');
    const countEl = document.getElementById('count');
    const emptyEl = document.getElementById('empty');

    // Helper: format currency
    const currency = n => {
      if(n===null||n===undefined||n==='') return 'POA';
      const num = typeof n==='number' ? n : parseFloat(n);
      if(isNaN(num)) return 'POA';
      return num.toLocaleString('en-AU', { style:'currency', currency:'AUD', maximumFractionDigits:0 });
    };

    // Helper: image URL handling (simplified for Firestore)
    function getImageURL(urlOrPath){
        // We assume the Firestore document fields (Main_image, gallery items)
        // contain the direct, full public URL to the image.
        if (urlOrPath && typeof urlOrPath === 'string' && urlOrPath.length > 0) {
            return urlOrPath;
        }
        return "assets/placeholder.jpg";
    }

    // Map Firestore document data -> list item shape
    function mapDocToItem(doc){
      const rec = doc.data();
      const statusRaw = (rec.Status || "").toString().toLowerCase();       // e.g. "available" / "sold"
      const conditionRaw = (rec.Condition || "").toString().toLowerCase(); // "new" / "used" / "demo"
      const sold = statusRaw === "sold";
      const length = rec.Size ? `${rec.Size} ft` : "";
      
      // Get image URL using the new helper
      const hero = rec.Main_image || (Array.isArray(rec.gallery) && rec.gallery[0]);
      const thumb = getImageURL(hero); 
      
      const price =
        typeof rec.Price === "number" ? rec.Price :
        (parseFloat((rec.Price || "").toString().replace(/[^\d.]/g,"")) || null);

      return {
        id: doc.id,
        brand: rec.Brand || "",
        title: rec.Title || [rec.Brand, rec.Model].filter(Boolean).join(" ") || "(Untitled)",
        price,
        category: conditionRaw, // used by Condition filter
        status: statusRaw,       // keep the raw lowercase
        sold,
        length,
        sleeps: rec.berths || "",
        axleConfiguration: rec.axleConfiguration || rec.Axle || "",
        suspension: rec.suspension || "",
        tare_kg: rec.tare_kg,
        atm_kg: rec.atm_kg,
        description: rec.description || "",
        featured: !!rec.featured,
        thumbnail: thumb,
        // Assuming gallery items are also full URLs
        images: [
          getImageURL(hero),
          ...(Array.isArray(rec.gallery) ? rec.gallery.map(getImageURL) : [])
        ].filter(Boolean),
        date_created: rec.created?.toDate()?.toISOString() || new Date().toISOString(), // Handle Firestore Timestamp
      };
    }

    // Rendering HTML for a single caravan card
    function cardHTML(it){
      const href = 'caravan.html?id=' + encodeURIComponent(it.id);
      const meta = [it.length, it.sleeps ? `${it.sleeps} berth` : '', it.axleConfiguration].filter(Boolean).join(' • ');
      return `
        <a href="${href}" class="rounded-xl border border-slate-200 overflow-hidden bg-white shadow-lg hover:shadow-xl transition duration-300 block">
          <div class="relative">
            <img src="${it.thumbnail}" alt="${it.title||''}" class="w-full h-48 object-cover bg-slate-100" onerror="this.onerror=null;this.src='assets/placeholder.jpg';">
            <div class="absolute top-2 left-2 flex gap-2">
              ${it.category ? `<span class="inline-block text-xs px-2 py-1 rounded-full bg-blue-600 text-white font-medium">${it.category==='new'?'New':it.category.charAt(0).toUpperCase()+it.category.slice(1)}</span>` : ''}
              ${it.featured ? `<span class="inline-block text-xs px-2 py-1 rounded-full bg-amber-500 text-white font-medium">Featured</span>` : ''}
              ${it.status==='sold' ? `<span class="inline-block text-xs px-2 py-1 rounded-full bg-red-600 text-white font-medium">Sold</span>` : ''}
            </div>
          </div>
          <div class="p-5">
            <h3 class="font-bold text-lg text-slate-900">${it.title||'(Untitled)'}</h3>
            <p class="mt-1 text-sm text-slate-600">${meta}</p>
            <p class="mt-3 font-extrabold text-xl text-blue-700">${currency(it.price)}</p>
          </div>
        </a>
      `;
    }

    function matches(it){
      const q = (qEl.value||'').toLowerCase().trim();
      const brand = (brandEl.value||'').toLowerCase();
      const cond = (condEl.value||'').toLowerCase();
      const status = (statusEl.value||'').toLowerCase();

      if (brand && (it.brand||'').toLowerCase() !== brand) return false;
      if (cond && (it.category||'') !== cond) return false;
      if (status) {
        const s = it.status || (it.sold ? 'sold' : 'available');
        if (s !== status) return false;
      }
      if (q) {
        // Search logic remains the same
        const tmp = document.createElement('div'); tmp.innerHTML = it.description || '';
        const hay = [
          it.title, it.brand, it.length, it.suspension, it.axleConfiguration,
          it.category, it.status, tmp.textContent || '', (it.sleeps ?? '')
        ].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    }

    function sortList(list){
      switch(sortEl.value){
        case 'price-asc':  return list.slice().sort((a,b)=>(parseFloat(a.price)||1e12)-(parseFloat(b.price)||1e12));
        case 'price-desc': return list.slice().sort((a,b)=>(parseFloat(b.price)||-1)-(parseFloat(a.price)||-1));
        default:           return list.slice().sort((a,b)=>new Date(b.date_created||0).getTime() - new Date(a.date_created||0).getTime());
      }
    }

    function render(list){
      const filtered = sortList(list.filter(matches));
      grid.innerHTML = filtered.map(cardHTML).join('');
      countEl.textContent = filtered.length;
      emptyEl.classList.toggle('hidden', filtered.length > 0);
      loadingEl.classList.add('hidden'); // Hide loading spinner once render is called
    }

    // Populate brand dropdown dynamically
    function populateBrands(items){
      const brands = Array.from(new Set(items.map(i => (i.brand||'').trim()).filter(Boolean))).sort();
      brandEl.innerHTML = '<option value="">All brands</option>' + brands.map(b => `<option value="${b}">${b}</option>`).join('');
    }
    
    // --- Firestore Data Listener and Auth ---
    async function setupFirebaseListener() {
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            console.log("Firebase Auth success.");

            const itemsRef = collection(db, COLLECTION_PATH);
            
            // Create a query that orders by creation date descending
            const q = query(itemsRef, orderBy('created', 'desc'));

            // Set up the real-time listener
            onSnapshot(q, (snapshot) => {
                const items = [];
                snapshot.forEach(doc => {
                    try {
                        items.push(mapDocToItem(doc));
                    } catch (e) {
                        console.error("Error mapping document:", doc.id, e);
                    }
                });

                window.__STOCK = items; // Store data globally for filtering
                populateBrands(items);
                render(items); // Initial render with all data
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
                loadingEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                emptyEl.textContent = 'Could not load stock: ' + error.message;
            });

        } catch (error) {
            console.error("Firebase Auth or Setup Error:", error);
            loadingEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
            emptyEl.textContent = 'Authorization failed. Please ensure Firebase is configured.';
        }
    }

    // Bind filters
    [qEl, brandEl, condEl, statusEl, sortEl].forEach(el => el.addEventListener('input', () => render(window.__STOCK||[])));
    condEl.addEventListener('change', () => render(window.__STOCK||[]));
    statusEl.addEventListener('change', () => render(window.__STOCK||[]));
    brandEl.addEventListener('change', () => render(window.__STOCK||[]));
    sortEl.addEventListener('change', () => render(window.__STOCK||[]));
    
    // Start the whole process
    setupFirebaseListener();

  </script>
</body>
</html>
